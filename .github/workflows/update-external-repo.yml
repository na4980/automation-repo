name: Update External Repository

on:
  workflow_dispatch:
    inputs:
      target_owner:
        description: 'Target repository owner'
        required: true
        default: 'tokamak-network'
      target_repo:
        description: 'Target repository name'
        required: true
        default: 'trh-sdk'
      update_message:
        description: 'Update message'
        required: true
        default: 'Automated update'

jobs:
  update-external-repo:
    runs-on: ubuntu-latest
    permissions: write-all
    
    steps:
      - name: Setup variables
        id: vars
        run: |
          branch_name="automation-update-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT

      - name: Setup authentication with custom PAT
        env:
          # ğŸ”‘ ìƒˆë¡œìš´ Secret ì´ë¦„ ì‚¬ìš© (GITHUB_TOKENê³¼ ì¶©ëŒ ë°©ì§€)
          MY_PERSONAL_TOKEN: ${{ secrets.MY_PERSONAL_TOKEN }}
        run: |
          echo "ğŸ” Setting up custom PAT authentication..."
          
          # PAT ì¡´ì¬ í™•ì¸
          if [ -z "$MY_PERSONAL_TOKEN" ]; then
            echo "âŒ MY_PERSONAL_TOKEN secret not found!"
            echo ""
            echo "Please create a new repository secret:"
            echo "1. Go to: Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Click: New repository secret"
            echo "3. Name: MY_PERSONAL_TOKEN"
            echo "4. Secret: [Your GitHub PAT starting with ghp_]"
            exit 1
          fi
          
          # PAT ìœ íš¨ì„± í™•ì¸
          echo "Testing PAT validity..."
          if curl -s -H "Authorization: Bearer $MY_PERSONAL_TOKEN" https://api.github.com/user | jq -r '.login' | grep -v null; then
            echo "âœ… PAT is valid"
          else
            echo "âŒ PAT is invalid or expired"
            echo "Please generate a new PAT with 'public_repo' scope"
            exit 1
          fi
          
          # GitHub CLI ì¸ì¦ (ê¸°ë³¸ í† í° ì œê±°)
          gh auth logout 2>/dev/null || true
          echo "$MY_PERSONAL_TOKEN" | gh auth login --with-token
          
          # Git ì„¤ì •
          git config --global user.name "na4980"
          git config --global user.email "na4980@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://x-access-token:$MY_PERSONAL_TOKEN@github.com" > ~/.git-credentials
          
          echo "âœ… Authentication setup completed"

      - name: Verify authentication
        env:
          MY_PERSONAL_TOKEN: ${{ secrets.MY_PERSONAL_TOKEN }}
        run: |
          echo "ğŸ” Verifying authentication..."
          
          # GitHub CLI ìƒíƒœ í™•ì¸
          gh auth status
          
          # API ì§ì ‘ í…ŒìŠ¤íŠ¸
          user=$(curl -s -H "Authorization: Bearer $MY_PERSONAL_TOKEN" https://api.github.com/user | jq -r '.login')
          echo "Authenticated as: $user"
          
          # ì €ì¥ì†Œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          echo "Testing repository access..."
          gh repo view ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}

      - name: Ensure fork exists
        env:
          MY_PERSONAL_TOKEN: ${{ secrets.MY_PERSONAL_TOKEN }}
        run: |
          echo "ğŸ´ Managing fork..."
          
          if gh repo view ${{ github.repository_owner }}/${{ github.event.inputs.target_repo }} >/dev/null 2>&1; then
            echo "âœ… Fork already exists"
          else
            echo "Creating fork..."
            gh repo fork ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }} --clone=false
            sleep 10
          fi

      - name: Clone and update repository
        env:
          MY_PERSONAL_TOKEN: ${{ secrets.MY_PERSONAL_TOKEN }}
        run: |
          echo "ğŸ“¥ Cloning and updating repository..."
          
          # í´ë¡ 
          rm -rf trh-sdk_fork
          git clone https://x-access-token:$MY_PERSONAL_TOKEN@github.com/${{ github.repository_owner }}/${{ github.event.inputs.target_repo }}.git trh-sdk_fork
          cd trh-sdk_fork
          
          # upstream ì„¤ì •
          git remote add upstream https://github.com/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}.git
          git fetch upstream
          git checkout -b ${{ steps.vars.outputs.branch_name }} upstream/main
          
          # íŒŒì¼ ìˆ˜ì •
          mkdir -p config
          echo '{"updated":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","message":"${{ github.event.inputs.update_message }}"}' > config/automation_config.json
          
          # ì»¤ë°‹
          git add .
          git commit -m "ğŸ¤– Automated update: ${{ github.event.inputs.update_message }}"
          
          # í‘¸ì‹œ
          git push https://x-access-token:$MY_PERSONAL_TOKEN@github.com/${{ github.repository_owner }}/${{ github.event.inputs.target_repo }}.git ${{ steps.vars.outputs.branch_name }}

      - name: Create Pull Request
        env:
          MY_PERSONAL_TOKEN: ${{ secrets.MY_PERSONAL_TOKEN }}
        run: |
          echo "ğŸ“ Creating pull request..."
          
          gh pr create \
            --repo ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }} \
            --title "ğŸ¤– Automated update: ${{ github.event.inputs.update_message }}" \
            --body "Automated update from na4980/automation-repo" \
            --base main \
            --head ${{ github.repository_owner }}:${{ steps.vars.outputs.branch_name }}